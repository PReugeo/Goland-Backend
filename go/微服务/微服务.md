## 微服务架构核心组件

* API 网关
* 服务注册中心
* 服务配置中心
* 服务通信
* 服务治理
* 服务监控
* 服务追踪

### API 网关

**相关功能**

* 路由
* 认证和授权
* 缓存响应结果
* 重试、熔断、限速、QoS
* 负载均衡
* 日志、监控、链路追踪
* 过滤
* 聚合查询
* 灰度发布，蓝绿部署

### 服务注册中心

注册中心一般包含如下几个功能：

1. 服务发现：

   - 服务注册/反注册：保存服务提供者和服务调用者的信息
   - 服务订阅/取消订阅：服务调用者订阅服务提供者的信息，最好有实时推送的功能
   - 服务路由（可选）：具有筛选整合服务提供者的能力。

2. 服务配置（不包括其它无关配置）：

   - 配置订阅：服务提供者和服务调用者订阅微服务相关的配置
   - 配置下发（可选）：主动将配置推送给服务提供者和服务调用者

3. 服务健康检测

   * 主动
   * 被动

   - 检测服务提供者的健康情况

**数据一致性**

* CP 型注册中心，牺牲可用性来保证数据强一致性
  * zooKeeper
  * Etcd
  * Consul
* AP 型注册中心，牺牲一致性来保证可用性
  * Eureka

![img](/Users/yanjigang01/Golang-Backend/go/微服务/image/1460000023568317.gif)

### 配置中心

* 集中化管理与配置切片
* 版本化与变更审计
* 动态刷新
* 高可用
* 弱依赖
* Push/Pull
* SDK 支持

Apollo 架构

![overall-architecture](/Users/yanjigang01/Golang-Backend/go/微服务/image/overall-architecture.png)

[Apollo 服务配置中心](https://github.com/apolloconfig/apollo)

### 服务通信

**同步**

* RPC（bRPC, Dubbo, Thrift, gRPC）也可异步
* Rest

**异步**

* RabbitMQ
* Kafka

### 服务治理

* 节点管理
  * 注册中心主动摘除机制
  * 服务消费者摘除机制
* 负载均衡算法
  * 随机
  * （加权）轮询
  * 最小活跃调用
  * 一致性 Hash
* 服务路由
  * 灰度发布
  * 多机房就近访问
* 服务端故障
  * 【集群故障】限流（阈值）
  * 【集群故障】降级（分流）
  * 【单 IDC】切流（DNS、分组）
  * 【单机】重启（设置比例）
  * 【单机】屏蔽
* 服务端调用失败
  * 超时
  * 重试
  * 备份请求
  * 熔断

### 服务监控

* 数据采集
  * 指标
  * 日志
  * 追踪
* 数据处理
  * 存储
  * 计算
  * 告警
* 数据可视化

对数据指标进行采集，通过数据传输存储数据，数据计算并进行数据可视化，数据报警

### 服务追踪

通过 `traceId` 在网络中传递，追踪整个微服务调用链路

通过 `spanId` 追踪调用链路顺序

## 微服务开发与测试

* 接口设计合理，规范格式，稳定不易变
  * 新增接口，原接口不变
  * 增加接口版本，老版本接口不受影响
* 文档清晰：swagger，Spring REST Docs
* 充分进行单元测试和集成测试，践行 TDD
  * Postman API 测试
  * Selenium 自动化测试

